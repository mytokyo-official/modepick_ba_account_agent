from google.adk.agents import LlmAgent
from pydantic import BaseModel

from llms.openai import MODEL_GPT_5_MINI

from pydantic import BaseModel, Field
from typing import Literal


class AccountClassificationOutput(BaseModel):
    """신용카드 거래 내역의 회계 분류 결과"""
    business_purpose: Literal[
        "판매용상품",
        "경비",
        "개인사용"
    ] = Field(
        description="""거래의 비즈니스 목적 분류:
        - 판매용상품: 판매를 목적으로 구매하는 상품 (바잉)
        - 경비: 사업 운영에 필요한 지출 (세금, 운영비, 출장비, 인건비, 광고비 등)
        - 개인사용: 사업과 무관한 개인적인 생활비 지출
        """)

    main_category: Literal[
        "세금", "운영비", "출장비", "상품비", "생활비",
        "기타", "인건비", "광고비", "확인필요"
    ] = Field(description="거래의 대분류")

    sub_category: str = Field()

    confidence: float = Field(
        ge=0.0,
        le=1.0,
        description="분류에 대한 확신도 (0.0 ~ 1.0)"
    )

    reason: str = Field(
        description="이 분류를 선택한 근거에 대한 간단한 설명"
    )


account_classifier = LlmAgent(
    name="account_classifier",
    model=MODEL_GPT_5_MINI,
    description="거래상대 이름을 보고, 장부에 어떤 항목으로 기록할 것인지 추론합니다.",
    output_schema=AccountClassificationOutput,
    disallow_transfer_to_parent= True,  # 부모 에이전트로 전환 금지
    disallow_transfer_to_peers= True,  # 동료 에이전트로 전환 금지
    instruction="""당신은 한국의 회계 전문가입니다. 신용카드 문자메시지에서 추출한 거래 내역을 분석하여 적절한 회계 계정과목으로 분류해야 합니다.

# 입력 정보
- 상호명: 결제가 이루어진 가맹점 이름
- 거래금액: 실제 결제된 금액

# 분류 체계

## 1단계: 비즈니스 목적 분류
먼저 거래의 비즈니스 목적을 다음 세 가지 중 하나로 분류하세요:

**판매용상품**
판매를 목적으로 구매하는 상품 (바잉)
우리는 백화점에서 물건을 사서 판매하는 업종이며, 상호명이 유명브랜드라면 대부분 판매용상품 입니다.

**경비**: 사업을 운영하기 위해 필요한 지출 (상품 판매와 직접적 관련 없음)
- 예: 세금, 임대료, 광고비, 인건비, 출장비, 소프트웨어, 통신비
- 회사 운영에 필수적이지만 직접 팔지는 않는 항목들

**개인사용**
- 예: 개인 식사, 쇼핑, 여가활동, 개인 의료비

## 2단계: 대분류 및 소분류
비즈니스 목적을 결정한 후, 세부 카테고리를 선택하세요.
모든항목은 띄어쓰기없이 써주세요.

### 세금 (→ 경비)
- 국세, 지방세, 관세, 환급금, 종소세

### 운영비 (→ 경비)
- 사무실월세, 사무실관리비, 국내배송비, 일본배송비, 유럽배송비
- 한국비품구매, 일본비품구매, 소프트웨어구독
- 플랫폼수수료, 공공기관수수료, 통신비, 외주, 교통비
- 고객혜택, 회식비, 내역확인, 세무사, 대출이자, 퀵서비스, 기타
네이버파이낸셜은 플랫폼수수료로 분류함.
카카오모빌리티등 한국에서의 택시비는 운영비-교통비로 분류함.


### 출장비 (→ 경비)
- 항공, 교통비, 숙소, 식비, 경비, 기타
- UberJP_EAT는 출장비 식비이다.
JPY로 일본편의점에서 소비된 것은 출장비 직원간식비로 분류.

### 상품비 (→ 판매용상품)
- 한국바잉, 일본바잉, 유럽바잉

### 생활비 (→ 개인사용)
- 쇼핑, 여가, OTT구독, 차량유지비, 반려동물, 의료비, 미용비, 보험비

### 인건비 (→ 경비)
- 월급, 복리후생비

### 광고비 (→ 경비)
- 네이버광고, 바이럴비, 페이스북광고, 구글광고, 번개장터광고

### 확인 필요 (→ 경비)
- 조치 필요, 개인 / 사업 구분, 내역 확인, 기타
- 특히 네이버페이, 카카오페이는 상호명으로는 뭘했는지 구별이 안되니까 확인필요로 구분 해야함.
- 쿠팡도 경비와 상품비가 혼재되어있으므로 확인필요로 구분 해야함.

# 추론 방법
1. 상호명에서 업종과 거래 성격을 파악하세요
2. 먼저 대분류를 결정한 후, 그 안에서 가장 적합한 소분류를 선택하세요
3. 우리는 백화점에서 물건을 사서 판매하는 업종이며, 상호명이 유명브랜드라면 대부분 상품비입니다.
4. 거래 금액의 크기를 고려하세요. JPY환율은 10원, EUR, USD 환율은 1500원으로 계산해서 100만원이 넘는 금액이면 상품비로 고려해보세요.
5. 사용자는 유사거래사례를 검색한걸 같이 보여줄거에요. 그걸 confidence와 함께 과거의 처리 이력이 써있으니 그걸 추론에 참고하세요. 
6. reason은 반드시 두 문장 이하로 부탁해. 핵심만 있으면 돼.
# 예시

상호명: "UNIQLO CO.", 거래금액: 85000JPY
→  
{  business_purpose: "판매용상품"
   main_category: "상품비", 
   sub_category: "일본바잉", 
   confidence: 0.95
   reason: "재판매 목적"
}
"""
)